{% extends 'base.html' %}

{% block content %}

    <main class="container-fluid no-gutters mx-auto">
            {{ current_ordering}}
            {{  current_categories }}
            {{ search_query }}
            {{current_subcategories}}
        <div class="row">
            <div class="col-12">
                <h2 class="text-center">Shop Our Products</h2>
            </div>
        </div>
        <div class="row">
            <div class="col-12 col-md-6 my-auto order-md-last d-flex justify-content-center justify-content-md-end">
                <select id="sorting-menu" class="custom-select custom-select-sm w-50">
                    <option value="default" {% if current_ordering == 'None_None' %}selected{% endif %}>Sort by...</option>
                    <option value="name|asc" {% if current_ordering == 'name' %}selected{% endif %}>Name (A to Z)</option>
                    <option value="name|desc" {% if current_ordering == '-name' %}selected{% endif %}>Name (Z to A)</option>
                    <option value="price|asc" {% if current_ordering == 'price' %}selected{% endif %}>Price (low to high)</option>
                    <option value="price|desc" {% if current_ordering == '-price' %}selected{% endif %}>Price (high to low)</option>
                    <option value="current_rating|asc" {% if current_ordering == 'current_rating' %}selected{% endif %}>Rating (low to high)</option>
                    <option value="current_rating|desc" {% if current_ordering == '-current_rating' %}selected{% endif %}>Rating (high to low)</option>
                </select>
            </div>
            <div class="col-12 col-md-6 order-md-first">
                <p class="text-muted mt-3 text-center text-md-left">
                    {% if search_results or current_categories or current_ordering or current_subcategories == 'None' %}
                        <span class="small"><a href="{% url 'products' %}">Back to All Products</a> | </span>
                    {% endif %}
                    Showing {{ products|length }} Product{%if products|length > 1 %}s{%endif%}{% if search_results %} related to <strong>"{{ search_results }}"</strong>{% endif %}
                    
                </p>
            </div>
        </div>
        <div class="row my-3 no-gutters">
            <div class="card-deck">
                {% for product in products %}
                    <div class="col-sm-6 col-md-6 col-lg-4 col-xl-3 my-3">
                        {% include "./includes/components/productcard.html" %} 
                    </div>
                {% endfor %}
            </div>
        </div>
        {% include "./includes/components/pagination.html" %}    
    </main>
    
{% endblock %}
{% block postloadjs %}
    {{ block.super }}

    <script type="text/javascript">
        // get the selector element from the dom
        $('#sorting-menu').change(function() {
            
            const selected = $(this);

            // Get the current URL
            const pageUrl = new URL(window.location);
            
            // get the selected menu option value
            let menuChoiceValue = selected.val();

            if(menuChoiceValue != 'default') {
                // split the value into an array
                let ordering = menuChoiceValue.split('|')[0];
                let direction = menuChoiceValue.split('|')[1];

                // set the ordering and direction query parameters in the URL
                pageUrl.searchParams.set('ordering', ordering);
                pageUrl.searchParams.set('direction', direction);

                // redirect to the new URL which includes the above parameters
                window.location.replace(pageUrl);

            } else {

                // remove the ordering and direction query parameters from the URL
                pageUrl.searchParams.delete('ordering');
                pageUrl.searchParams.delete('direction');

                window.location.replace(pageUrl);
            }

        })
    </script>
{% endblock %}